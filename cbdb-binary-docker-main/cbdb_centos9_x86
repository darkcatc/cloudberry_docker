FROM quay.io/centos/centos:stream9

RUN     echo root:Hashdata@123 | chpasswd \
        && yum install -y epel-release

RUN     yum install --allowerasing -y apr apr-util bash bzip2 curl iproute krb5-devel libcurl libevent libuuid libuv libxml2 libyaml libzstd openldap openssh openssh-clients openssh-server openssl openssl-libs perl python3 python3-psycopg2 python3-psutil python3-pyyaml python3.11 python3.11-devel readline rsync sed tar which zip zlib

RUN     yum install -y hostname iputils git passwd wget sudo net-tools sshpass procps

RUN     wget https://github.com/cloudberrydb/cloudberrydb/releases/download/1.6.0/cloudberry-db-1.6.0-1.el9.x86_64.rpm -O /tmp/cloudberry-db-release.rpm

RUN     yum install -y /tmp/cloudberry-db-release.rpm

COPY ./configs/* /tmp/

RUN     cat /tmp/sysctl.conf.add >> /etc/sysctl.conf \
        && cat /tmp/limits.conf.add >> /etc/security/limits.conf \
        && cat /usr/share/zoneinfo/Asia/Shanghai > /etc/localtime \
        && echo "mdw" > /tmp/gpdb-hosts \
        && echo "/usr/local/lib" >> /etc/ld.so.conf \
        && echo "/usr/local/lib64" >> /etc/ld.so.conf \
        && ldconfig \
        && chmod 777 /tmp/gpinitsystem_singlenode \
        && chmod 777 /tmp/init_system.sh \
        && hostname > ~/orig_hostname \
        && /usr/sbin/groupadd gpadmin \
        && /usr/sbin/useradd gpadmin -g gpadmin -G wheel \
        && echo "Hashdata@123"|passwd --stdin gpadmin \
        && echo "gpadmin        ALL=(ALL)       NOPASSWD: ALL" >> /etc/sudoers \
        && echo "root        ALL=(ALL)       NOPASSWD: ALL" >> /etc/sudoers \
        && chown -R gpadmin: /home/gpadmin \
        && echo "export COORDINATOR_DATA_DIRECTORY=/data0/database/master/gpseg-1" >> /home/gpadmin/.bashrc \
        && echo "source /usr/local/cloudberry-db/greenplum_path.sh" >> /home/gpadmin/.bashrc \
        && chown -R gpadmin.gpadmin /usr/local/cloudberry* \
        && ssh-keygen -A \
        && echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config

EXPOSE 5432 22

VOLUME [ "/sys/fs/cgroup" ]
CMD ["bash","-c","/tmp/init_system.sh"]