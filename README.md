# HashData Lightning 2.0 Docker é›†ç¾¤éƒ¨ç½²

## é¡¹ç›®ç®€ä»‹

åŸºäº Docker å’Œ Docker Compose çš„ HashData Lightning 2.0 é›†ç¾¤éƒ¨ç½²è§£å†³æ–¹æ¡ˆã€‚
é€šè¿‡Shellå®ç°ï¼Œåªæ”¯æŒLinuxçš„æ“ä½œç³»ç»Ÿã€‚

- **ä½œè€…**: Vance Chen
- **HashData ç‰ˆæœ¬**: 2.0.0
- **åŸºç¡€é•œåƒ**: CentOS 9 Stream
- **é›†ç¾¤æ¶æ„**: 1 Master + 2 Segment (æ—  Mirror)
- **å­˜å‚¨ç®¡ç†**: Docker å·ç®¡ç†ï¼Œæ™ºèƒ½æƒé™é€‚é…

## æ¶æ„ç‰¹æ€§

âœ… **æ™ºèƒ½æƒé™é€‚é…** - è‡ªåŠ¨æ£€æµ‹å¹¶é€‚é…ä¸åŒç¯å¢ƒçš„æƒé™æ˜ å°„  
âœ… **Docker å·ç®¡ç†** - æ•°æ®æŒä¹…åŒ–å®Œå…¨ç”± Docker ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®æƒé™  
âœ… **ä¸€é”®éƒ¨ç½²** - å®Œæ•´çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹  
âœ… **SSH è‡ªåŠ¨é…ç½®** - è‡ªåŠ¨è®¾ç½®é›†ç¾¤é—´æ— å¯†ç SSHé€šä¿¡  
âœ… **ç¯å¢ƒéš”ç¦»** - æ¯ä¸ªå®¹å™¨ç‹¬ç«‹çš„æ•°æ®å­˜å‚¨ç©ºé—´  

## é¡¹ç›®ç»“æ„

```
hashdata_docker/
â”œâ”€â”€ README.md                   # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ hashdata.env                # ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
â”œâ”€â”€ docker-compose.yml          # Docker Compose ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ Dockerfile                  # Docker é•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ arch.png                    # æ¶æ„å›¾
â”œâ”€â”€ scripts/                    # è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ build.sh               # é•œåƒæ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ init.sh                # é›†ç¾¤åˆå§‹åŒ–è„šæœ¬ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰
â”‚   â”œâ”€â”€ start.sh               # é›†ç¾¤å¯åŠ¨è„šæœ¬ï¼ˆæ—¥å¸¸ä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ stop.sh                # é›†ç¾¤åœæ­¢è„šæœ¬ï¼ˆä¿ç•™æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ destroy.sh             # é›†ç¾¤é”€æ¯è„šæœ¬ï¼ˆåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ clean.sh               # ç¯å¢ƒæ¸…ç†è„šæœ¬
â”‚   â””â”€â”€ update_configs.sh      # é…ç½®æ›´æ–°å·¥å…·
â””â”€â”€ configs/                    # é…ç½®æ–‡ä»¶ç›®å½•
    â”œâ”€â”€ cluster/               # é›†ç¾¤é…ç½®
    â”‚   â”œâ”€â”€ gpinitsystem.conf  # GP åˆå§‹åŒ–é…ç½®
    â”‚   â””â”€â”€ hosts              # ä¸»æœºåˆ—è¡¨
    â”œâ”€â”€ system/                # ç³»ç»Ÿé…ç½®
    â”‚   â”œâ”€â”€ sysctl.conf        # å†…æ ¸å‚æ•°
    â”‚   â””â”€â”€ limits.conf        # ç³»ç»Ÿé™åˆ¶
    â””â”€â”€ init/                  # åˆå§‹åŒ–è„šæœ¬
        â”œâ”€â”€ init_cluster.sh    # é›†ç¾¤åˆå§‹åŒ–è„šæœ¬
        â””â”€â”€ setup_user.sh      # ç”¨æˆ·è®¾ç½®è„šæœ¬
```

## å¿«é€Ÿå¼€å§‹

### 1. æ„å»ºé•œåƒ

```bash
# æ„å»º HashData Docker é•œåƒ (çº¦ 5-6GBï¼Œéœ€è¦ç½‘ç»œä¸‹è½½)
./scripts/build.sh
```

**æ³¨æ„**: é¦–æ¬¡æ„å»ºéœ€è¦ä¸‹è½½çº¦ 1500MB+ çš„ HashData å®‰è£…åŒ…ï¼Œé¢„è®¡è€—æ—¶ 10-30 åˆ†é’Ÿã€‚

### 2. åˆå§‹åŒ–é›†ç¾¤ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰

```bash
# åˆå§‹åŒ–é›†ç¾¤ï¼Œåˆ›å»º Docker å·å’Œé…ç½®æ•°æ®åº“
./scripts/init.sh
```

**æ³¨æ„**: æ­¤è„šæœ¬ä»…ç”¨äºé¦–æ¬¡åˆå§‹åŒ–ï¼Œæœ‰é‡å¤æ‰§è¡Œæ£€æŸ¥æœºåˆ¶ã€‚

### 3. æ—¥å¸¸å¯åœæ“ä½œ

```bash
# å¯åŠ¨å·²åˆå§‹åŒ–çš„é›†ç¾¤
./scripts/start.sh

# åœæ­¢é›†ç¾¤ï¼ˆä¿ç•™æ•°æ®ï¼‰
./scripts/stop.sh
```

### 4. è¿æ¥æ•°æ®åº“

```bash
# è¿æ¥åˆ° Master èŠ‚ç‚¹
docker exec -it hashdata-master su - gpadmin -c "psql"

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
docker exec -it hashdata-master su - gpadmin -c "psql -c 'SELECT * FROM gp_segment_configuration;'"
```

### 5. å®Œå…¨æ¸…ç†ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

```bash
# é”€æ¯é›†ç¾¤å’Œæ‰€æœ‰æ•°æ®ï¼ˆéœ€è¦è¾“å…¥ 'yes' ç¡®è®¤ï¼‰
./scripts/destroy.sh

# æ¸…ç†Dockeré•œåƒå’Œå®¹å™¨ï¼ˆéœ€è¦è¾“å…¥ 'yes' ç¡®è®¤ï¼‰
./scripts/clean.sh
```

**âš ï¸ è­¦å‘Š**: 
- `destroy.sh` ä¼šåˆ é™¤æ‰€æœ‰é›†ç¾¤æ•°æ®ï¼Œæ— æ³•æ¢å¤
- `clean.sh` ä¼šåˆ é™¤ Docker é•œåƒï¼Œé‡æ–°ä½¿ç”¨éœ€è¦é‡æ–°æ„å»º

## è„šæœ¬è¯´æ˜

| è„šæœ¬ | ç”¨é€” | ä½¿ç”¨åœºæ™¯ | å®‰å…¨çº§åˆ« |
|------|------|----------|----------|
| `build.sh` | æ„å»ºDockeré•œåƒ | é¦–æ¬¡æ„å»ºæˆ–æ›´æ–°é•œåƒ | ğŸ“¦ éœ€è¦ç½‘ç»œä¸‹è½½ |
| `init.sh` | é›†ç¾¤åˆå§‹åŒ– | é¦–æ¬¡éƒ¨ç½²ï¼Œæœ‰é‡å¤æ‰§è¡Œæ£€æŸ¥ | ğŸ›¡ï¸ é˜²é‡å¤åˆå§‹åŒ– |
| `start.sh` | å¯åŠ¨é›†ç¾¤ | æ—¥å¸¸å¯åŠ¨å·²åˆå§‹åŒ–çš„é›†ç¾¤ | âœ… å®‰å…¨æ“ä½œ |
| `stop.sh` | åœæ­¢é›†ç¾¤ | æ—¥å¸¸åœæ­¢ï¼Œä¿ç•™æ•°æ® | âœ… å®‰å…¨æ“ä½œ |
| `destroy.sh` | é”€æ¯é›†ç¾¤ | å®Œå…¨åˆ é™¤é›†ç¾¤å’Œæ•°æ® | âš ï¸ éœ€è¦ç¡®è®¤ï¼Œä¸å¯æ¢å¤ |
| `clean.sh` | æ¸…ç†ç¯å¢ƒ | æ¸…ç†Dockeré•œåƒå’Œå®¹å™¨ | âš ï¸ éœ€è¦ç¡®è®¤ï¼Œåˆ é™¤é•œåƒ |

### è„šæœ¬å®‰å…¨æœºåˆ¶

- **é˜²é‡å¤åˆå§‹åŒ–**: `init.sh` ä¼šæ£€æŸ¥ç°æœ‰é›†ç¾¤ï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–
- **ç¡®è®¤æœºåˆ¶**: `destroy.sh` å’Œ `clean.sh` éœ€è¦è¾“å…¥ 'yes' ç¡®è®¤
- **èµ„æºæé†’**: `build.sh` ä¼šæé†’ç½‘ç»œå’Œç£ç›˜ç©ºé—´è¦æ±‚
- **æ“ä½œæŒ‡å¯¼**: æ‰€æœ‰è„šæœ¬éƒ½æä¾›è¯¦ç»†çš„ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®

### æ¨èæ“ä½œæµç¨‹

```
é¦–æ¬¡éƒ¨ç½²:
build.sh â†’ init.sh â†’ é›†ç¾¤å°±ç»ª

æ—¥å¸¸ä½¿ç”¨:
start.sh â‡„ stop.sh

é‡æ–°åˆå§‹åŒ–:
destroy.sh â†’ init.sh

å®Œå…¨æ¸…ç†:
destroy.sh â†’ clean.sh â†’ build.sh â†’ init.sh
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½® (hashdata.env)

- `HASHDATA_VERSION`: HashData ç‰ˆæœ¬å·
- `NETWORK_SUBNET`: ç½‘ç»œå­ç½‘
- `MASTER_PORT`: Master èŠ‚ç‚¹ç«¯å£
- `SEGMENT_PORT_BASE`: Segment èŠ‚ç‚¹èµ·å§‹ç«¯å£

### é›†ç¾¤é…ç½®

- **Master èŠ‚ç‚¹**: 1 ä¸ª (hashdata-master)
- **Segment èŠ‚ç‚¹**: 2 ä¸ª (hashdata-segment1, hashdata-segment2)
- **ç½‘ç»œæ¨¡å¼**: Bridge ç½‘ç»œï¼Œå›ºå®š IP åœ°å€
- **æ•°æ®æŒä¹…åŒ–**: Docker å·ç®¡ç† (hashdata_master_data, hashdata_segment1_data, hashdata_segment2_data)

## æ•°æ®ç®¡ç†

### Docker å·å­˜å‚¨

æœ¬é¡¹ç›®é‡‡ç”¨ Docker å·å®Œå…¨ç®¡ç†æ•°æ®æŒä¹…åŒ–ï¼š

- **Master æ•°æ®**: `hashdata_master_data` â†’ `/data/coordinator/`
- **Segment1 æ•°æ®**: `hashdata_segment1_data` â†’ `/data/primary/`
- **Segment2 æ•°æ®**: `hashdata_segment2_data` â†’ `/data/primary/`

### æ•°æ®ä½ç½®

Docker å·å®é™…å­˜å‚¨ä½ç½®ï¼š
```
/var/lib/docker/volumes/hashdata_master_data/_data
/var/lib/docker/volumes/hashdata_segment1_data/_data
/var/lib/docker/volumes/hashdata_segment2_data/_data
```

### æ•°æ®å¤‡ä»½

```bash
# æŸ¥çœ‹å·ä¿¡æ¯
docker volume ls | grep hashdata

# å¤‡ä»½æ•°æ®å·
docker run --rm -v hashdata_master_data:/data -v $(pwd):/backup alpine tar czf /backup/master_backup.tar.gz /data

# æ¢å¤æ•°æ®å·
docker run --rm -v hashdata_master_data:/data -v $(pwd):/backup alpine tar xzf /backup/master_backup.tar.gz -C /
```

## é…ç½®æ›´æ–°å·¥å…·

ä½¿ç”¨ `update_configs.sh` å·¥å…·å¯ä»¥åœ¨ä¸é‡å»ºé•œåƒçš„æƒ…å†µä¸‹æ›´æ–°é…ç½®ï¼š

```bash
# æ›´æ–°é…ç½®å¹¶é‡å¯æŒ‡å®šå®¹å™¨
./scripts/update_configs.sh -r hashdata-master

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
./scripts/update_configs.sh -l hashdata-master
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£å†²çª**: æ£€æŸ¥ç«¯å£ 15432 æ˜¯å¦è¢«å ç”¨
2. **å†…å­˜ä¸è¶³**: ç¡®ä¿ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜
3. **ç½‘ç»œé—®é¢˜**: æ£€æŸ¥ Docker ç½‘ç»œé…ç½®
4. **SSHè¿æ¥å¤±è´¥**: å®¹å™¨é—´SSHè‡ªåŠ¨é…ç½®å¤±è´¥

### æ™ºèƒ½æƒé™é€‚é…

é¡¹ç›®é‡‡ç”¨æ™ºèƒ½æƒé™æ£€æµ‹æœºåˆ¶ï¼Œè‡ªåŠ¨é€‚åº”ä¸åŒç¯å¢ƒï¼š

- **è‡ªåŠ¨æ£€æµ‹**: å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹æŒ‚è½½ç›®å½•æƒé™
- **åŠ¨æ€é€‚é…**: ä½¿ç”¨æ£€æµ‹åˆ°çš„ UID/GID åˆ›å»º gpadmin ç”¨æˆ·
- **è·¨å¹³å°**: æ”¯æŒ WSLã€Linuxã€macOS ç­‰å¹³å°
- **å…é…ç½®**: æ— éœ€æ‰‹åŠ¨ä¿®æ”¹å®¿ä¸»æœºç›®å½•æƒé™

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs hashdata-master
docker logs hashdata-segment1
docker logs hashdata-segment2

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker exec hashdata-master find /data -name "*.log" -type f
```

### é‡æ–°åˆå§‹åŒ–

å¦‚æœéœ€è¦é‡æ–°åˆå§‹åŒ–é›†ç¾¤ï¼š

```bash
# 1. é”€æ¯ç°æœ‰é›†ç¾¤
./scripts/destroy.sh

# 2. é‡æ–°åˆå§‹åŒ–
./scripts/init.sh
```

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿ Docker å’Œ Docker Compose å·²æ­£ç¡®å®‰è£…
2. å»ºè®®åˆ†é…è‡³å°‘ 8GB å†…å­˜ç»™ Docker
3. é¦–æ¬¡åˆå§‹åŒ–éœ€è¦ä¸‹è½½ HashData å®‰è£…åŒ…ï¼Œè¯·è€å¿ƒç­‰å¾…
4. `destroy.sh` ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œè¯·è°¨æ…ä½¿ç”¨
5. é›†ç¾¤åˆå§‹åŒ–å®Œæˆåï¼Œé»˜è®¤æ•°æ®åº“ç”¨æˆ·ä¸º `gpadmin`ï¼Œå¯†ç ä¸º `Hashdata@123`

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## è®¸å¯è¯

MIT License 